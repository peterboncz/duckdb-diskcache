# name: test/sql/disk_cache.test
# description: test disk_cache extension
# group: [sql]

require parquet

require disk_cache

statement ok
call enable_logging(level='debug');

statement ok
install httpfs

statement ok
load httpfs

query I
select message.substr(15) from duckdb_logs where message.substr(13,1) = '-';
----
DiskCache:fake_s3
DiskCache:HTTPFileSystem
DiskCache:HuggingFaceFileSystem
DiskCache:S3FileSystem

statement ok
install tpch

statement ok
load tpch

statement ok
call dbgen(sf=0.1);

statement ok
copy lineitem to 'lineitem.parquet';

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from disk_cache_stats();
----
6	0

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from disk_cache_stats();
----
6	6

# bytes_from_mem is 0 since the DuckDB ExternalFileCache is active (default)
query I
select sum(bytes_from_mem) = 0 from disk_cache_stats();
----
1

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from disk_cache_stats();
----
6	12	

# bytes_from_mem will be 0 (no separate memcache layer anymore)
query I
select sum(bytes_from_mem) >= 0 from disk_cache_stats();
----
1

statement ok
from disk_cache_config(1024, '.disk_cache2/', 1);

# Directory changed, so cache should be cleared
query I
select count(*) from disk_cache_stats();
----
0

query IIIII
select * replace(substr(cache_path,0,13) as cache_path) from disk_cache_config();
----
1073741824	.disk_cache2	0	1	1

# we function better if the file cache is off (we then memcache ourselves). But after the first query there should ne no reuse yet 
statement ok
set enable_external_file_cache = false;

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

# bytes_from_mem will be 0 (first query)
query I
select sum(bytes_from_mem) = 0 from disk_cache_stats();
----
1

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

# bytes_from_mem will be > 0 now
query I
select sum(bytes_from_mem) = 0 from disk_cache_stats();
----
0

query I
select message from duckdb_logs where log_level = 'ERROR';
----


statement ok
create or replace table hydrate as
(select uri, range_start_uri, range_size from disk_cache_stats() order by all);

statement ok
from disk_cache_config(1024, '.disk_cache3/', 192);

query IIIII
select * replace(substr(cache_path,0,13) as cache_path) from disk_cache_config();
----
1073741824	.disk_cache3	0	192	1


statement ok
select disk_cache_hydrate(uri, range_start_uri, range_size) from hydrate;
