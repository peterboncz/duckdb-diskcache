# name: test/sql/diskcache.test
# description: test diskcache extension
# group: [sql]

require parquet

require diskcache

statement ok
call enable_logging(level='debug');

statement ok
install tpch

statement ok
load tpch

statement ok
call dbgen(sf=0.1);

statement ok
copy lineitem to 'lineitem.parquet';

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from diskcache_stats();
----
6	0

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from diskcache_stats();
----
6	6

# bytes_from_mem is 0 since the DuckDB ExternalFileCache is active (default)
query I
select sum(bytes_from_mem) = 0 from diskcache_stats();
----
1

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

query II
select count(*), sum(usage_count) from diskcache_stats();
----
6	12	

# bytes_from_mem will be 0 (no separate memcache layer anymore)
query I
select sum(bytes_from_mem) >= 0 from diskcache_stats();
----
1

statement ok
from diskcache_config(1024, '.diskcache2/', 1);

# Directory changed, so cache should be cleared
query I
select count(*) from diskcache_stats();
----
0

query IIIIII
select * replace(substr(cache_path,0,12) as cache_path) from diskcache_config();
----
1024	.diskcache2	0	1	(empty)	1

# we function better if the file cache is off (we then memcache ourselves). But after the first query there should ne no reuse yet 
statement ok
set enable_external_file_cache = false;

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

# bytes_from_mem will be 0 (first query)
query I
select sum(bytes_from_mem) = 0 from diskcache_stats();
----
1

statement ok
select max(l_comment) from read_parquet('fake_s3://lineitem.parquet');

# bytes_from_mem will be > 0 now
query I
select sum(bytes_from_mem) = 0 from diskcache_stats();
----
0

query I
select message from duckdb_logs where log_level = 'ERROR';
----


statement ok
create or replace table hydrate as
(select uri, range_start, range_size from diskcache_stats() order by all);

statement ok
from diskcache_config(1024, '.diskcache3/', 255);

query IIIIII
select * replace(substr(cache_path,0,12) as cache_path) from diskcache_config();
----
1024	.diskcache3	0	255	(empty)	1

statement ok
select diskcache_hydrate(uri, range_start, range_size) from hydrate;
